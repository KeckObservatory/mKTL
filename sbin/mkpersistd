#! /usr/bin/env kpython3

description = """
This is a subprocess invoked by a mktl.Daemon.Store instance; its sole purpose
is to receive broadcasts of any 'persistent' items and queue any/all incoming
updates for persistent storage to disk. Where and how the value is stored is
governed entirely by the mktl/persist.py code.

The motivation for using a subprocess comes from two sources: one is the
simplicity of using the existing mKTL publish/subscribe machinery, the other
is to lighten the resource load on the 'main' daemon process.
"""

import argparse
import sys
import mktl
import select
import time


def main():

    config = parse_command_line()

    store = config.store
    uuid = config.uuid

    store = mktl.get(store)
    matches = 0
    watched = 0

    for item in store:
        key = item.key
        config = store.config[key]
        item_uuid = config['uuid']

        if item_uuid != uuid:
            continue

        matches += 1

        try:
            persist = config['persist']
        except KeyError:
            continue

        if persist == True:
            item.register(mktl.daemon._save_persistent)
            watched += 1


    if matches == 0:
        raise RuntimeError("no items found in '%s' for UUID %s" % (store, uuid))

    if watched == 0:
        print('No persistent items found, mkpersistd subprocess exiting.')
        sys.exit(0)

    mask = select.POLLIN | select.POLLPRI
    poller = select.poll()
    poller.register(sys.stdin, mask)

    while True:
        try:
            events = poller.poll(30000)
        except (KeyboardInterrupt, SystemExit):
            break

        for descriptor,event in events:
            if event & select.POLLERR:
                # Can't print a message about closing, if stdin is gone that
                # means stdout and stderr are gone too.
                sys.exit(0)

            if event & select.POLLIN:
                data = sys.stdin.read(1024)
                if data == '':
                    sys.exit(0)



def parse_command_line():

    arguments = dict()
    arguments['formatter_class'] = argparse.RawDescriptionHelpFormatter
    arguments['description'] = description
    ##arguments['epilog'] = epilog

    parser = argparse.ArgumentParser(**arguments)

    parser.add_argument('store', help='Name of the mKTL store')
    parser.add_argument('uuid', help='Unique identifier for the mKTL daemon')

    parsed = parser.parse_args()
    return parsed



if __name__ == '__main__':
    main()

# vim: set expandtab tabstop=8 softtabstop=4 shiftwidth=4 autoindent:
